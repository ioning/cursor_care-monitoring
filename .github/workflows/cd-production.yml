name: CD - Production

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: string

env:
  ENVIRONMENT: production
  KUBERNETES_NAMESPACE: care-monitoring-production

jobs:
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          echo "Deploying version: $VERSION"

      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'caremonitoring/api-gateway:${{ github.event.inputs.version || github.ref_name }}'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Run database migrations
        run: |
          kubectl run migration-job --image=caremonitoring/migration-runner:${{ github.event.inputs.version || github.ref_name }} \
            --restart=Never \
            --env="DB_HOST=postgres" \
            --env="DB_USER=${{ secrets.DB_USER_PRODUCTION }}" \
            --env="DB_PASSWORD=${{ secrets.DB_PASSWORD_PRODUCTION }}" \
            -- npm run db:migrate
          kubectl wait --for=condition=complete job/migration-job --timeout=10m
          kubectl delete job migration-job

      - name: Deploy to Kubernetes (Canary)
        run: |
          # Deploy canary version (10% traffic)
          kubectl set image deployment/api-gateway \
            api-gateway=caremonitoring/api-gateway:${{ github.event.inputs.version || github.ref_name }} \
            -n ${{ env.KUBERNETES_NAMESPACE }}
          
          # Wait for canary to be ready
          kubectl rollout status deployment/api-gateway -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=10m

      - name: Run smoke tests
        run: |
          echo "Running smoke tests on canary..."
          # Add smoke tests here

      - name: Promote to full deployment
        if: success()
        run: |
          # Scale canary to 100%
          kubectl scale deployment/api-gateway --replicas=10 -n ${{ env.KUBERNETES_NAMESPACE }}
          
          # Deploy all other services
          kubectl apply -f infrastructure/kubernetes/deployments/ -n ${{ env.KUBERNETES_NAMESPACE }}

      - name: Wait for full rollout
        run: |
          kubectl rollout status deployment/api-gateway -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=15m

      - name: Run health checks
        run: |
          echo "Running health checks..."
          # Add health checks here

      - name: Create deployment record
        run: |
          echo "Deployment completed: ${{ github.event.inputs.version || github.ref_name }}"
          # Create deployment record in tracking system

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to Production: ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Rollback deployment
        run: |
          kubectl rollout undo deployment/api-gateway -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl rollout status deployment/api-gateway -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=10m

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ðŸš¨ Production deployment failed and was rolled back"
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

