# Реализация геолокации подопечных

**Дата**: 2024-01-15  
**Версия**: 1.0.0  
**Статус**: ✅ Полностью реализовано

## Обзор

Реализована полная функциональность отслеживания геолокации подопечных в приложениях опекуна и диспетчера.

## Возможности

### Для опекунов (Guardian App)

1. **Карта геолокации подопечного**
   - Отображение текущего местоположения
   - Анимированный маркер с пульсацией
   - Информация о точности и времени обновления
   - Автоматическое обновление каждые 10 секунд

2. **История перемещений**
   - Просмотр истории за выбранный период
   - Визуализация пути перемещения
   - Список точек с временными метками
   - Фильтрация по датам

3. **Геозоны (Geofences)**
   - Отображение безопасных зон (зеленые круги)
   - Отображение запрещенных зон (красные круги)
   - Визуализация радиусов зон
   - Создание новых геозон

4. **Управление отслеживанием**
   - Кнопка включения/выключения отслеживания
   - Автоматическое центрирование на подопечном
   - Информация о последнем обновлении

### Для диспетчеров (Dispatcher App)

1. **Карта всех подопечных**
   - Отображение всех подопечных с активными вызовами
   - Маркеры с именами подопечных
   - Разделение на подопечных с геолокацией и без
   - Фильтрация по статусу вызовов

2. **Интеграция с вызовами**
   - Отображение вызовов без геолокации
   - Приоритетные маркеры для критичных вызовов
   - Переход к деталям вызова
   - Просмотр истории перемещений

3. **Автоматическое обновление**
   - Автообновление каждые 10 секунд
   - Ручное обновление по кнопке
   - Индикация статуса загрузки

## Архитектура

### Backend (Location Service)

**API Endpoints:**
- `POST /locations/wards/:wardId` - Запись геолокации
- `GET /locations/wards/:wardId/latest` - Последняя геолокация
- `GET /locations/wards/:wardId/history` - История перемещений
- `GET /locations/geofences` - Список геозон
- `POST /locations/geofences` - Создание геозоны

**Таблицы БД:**
- `locations` - История геолокаций
- `geofences` - Геозоны для подопечных

### Frontend

**Guardian App:**
- `src/api/location.api.ts` - API клиент
- `src/stores/location.ts` - Pinia store
- `src/components/WardLocationMap.vue` - Компонент карты
- Интеграция в `WardDetailView.vue`

**Dispatcher App:**
- `src/api/location.api.ts` - API клиент
- `src/stores/location.ts` - Pinia store
- `src/components/WardsLocationMap.vue` - Компонент карты всех подопечных
- Замена `MapView.vue` на новый компонент

## Компоненты

### WardLocationMap (Guardian App)

**Функции:**
- Отображение текущей геолокации подопечного
- История перемещений с визуализацией пути
- Отображение геозон
- Управление отслеживанием
- Фильтрация истории по датам

**Пропсы:**
- `wardId: string` - ID подопечного
- `wardName: string` - Имя подопечного

### WardsLocationMap (Dispatcher App)

**Функции:**
- Отображение всех подопечных с геолокацией
- Отображение вызовов без геолокации
- Фильтрация по статусу вызовов
- Автоматическое обновление
- Список подопечных в сайдбаре

## Использование

### В Guardian App

Компонент автоматически отображается на странице деталей подопечного:

```vue
<WardLocationMap :wardId="wardId" :wardName="wardName" />
```

### В Dispatcher App

Компонент используется как основная карта:

```vue
<WardsLocationMap />
```

## API Использование

### Получение последней геолокации

```typescript
import { locationApi } from '@/api/location.api';

const location = await locationApi.getLatestLocation(wardId);
```

### Получение истории

```typescript
const history = await locationApi.getLocationHistory(wardId, {
  from: '2024-01-01',
  to: '2024-01-31',
  page: 1,
  limit: 100,
});
```

### Получение геозон

```typescript
const geofences = await locationApi.getGeofences(wardId);
```

## Трекинг в реальном времени

Store автоматически управляет обновлением геолокации:

```typescript
import { useLocationStore } from '@/stores/location';

const locationStore = useLocationStore();

// Начать отслеживание (обновление каждые 10 секунд)
locationStore.startTracking(wardId, 10000);

// Остановить отслеживание
locationStore.stopTracking(wardId);
```

## Визуализация

### Маркеры

- **Текущая геолокация** - Анимированный маркер с пульсацией
- **История** - Маленькие синие точки
- **Вызовы** - Цветные маркеры по приоритету
- **Геозоны** - Полупрозрачные круги

### Цвета приоритетов

- `critical` - Красный (#ef4444)
- `high` - Оранжевый (#f59e0b)
- `medium` - Синий (#3b82f6)
- `low` - Серый (#64748b)

## Multi-tenancy

Все запросы автоматически фильтруются по `organization_id` из JWT токена.

## Производительность

- Автоматическое обновление каждые 10 секунд
- Кэширование локаций в store
- Оптимизированные запросы к БД
- Индексы для быстрого поиска

## Безопасность

- JWT аутентификация для всех запросов
- Фильтрация по организации
- Валидация данных на backend
- Защита от SQL инъекций

## Следующие шаги (опционально)

1. **Уведомления о выходе из геозоны**
   - Автоматические уведомления при выходе из безопасной зоны
   - Push-уведомления опекунам

2. **Маршруты и прогнозы**
   - Построение маршрутов
   - Прогнозирование движения
   - Анализ паттернов перемещения

3. **Офлайн режим**
   - Кэширование локаций
   - Синхронизация при восстановлении связи

4. **Расширенная аналитика**
   - Статистика перемещений
   - Тепловые карты
   - Отчеты о перемещениях

---

**Функциональность полностью реализована и готова к использованию!** ✅



**Дата**: 2024-01-15  
**Версия**: 1.0.0  
**Статус**: ✅ Полностью реализовано

## Обзор

Реализована полная функциональность отслеживания геолокации подопечных в приложениях опекуна и диспетчера.

## Возможности

### Для опекунов (Guardian App)

1. **Карта геолокации подопечного**
   - Отображение текущего местоположения
   - Анимированный маркер с пульсацией
   - Информация о точности и времени обновления
   - Автоматическое обновление каждые 10 секунд

2. **История перемещений**
   - Просмотр истории за выбранный период
   - Визуализация пути перемещения
   - Список точек с временными метками
   - Фильтрация по датам

3. **Геозоны (Geofences)**
   - Отображение безопасных зон (зеленые круги)
   - Отображение запрещенных зон (красные круги)
   - Визуализация радиусов зон
   - Создание новых геозон

4. **Управление отслеживанием**
   - Кнопка включения/выключения отслеживания
   - Автоматическое центрирование на подопечном
   - Информация о последнем обновлении

### Для диспетчеров (Dispatcher App)

1. **Карта всех подопечных**
   - Отображение всех подопечных с активными вызовами
   - Маркеры с именами подопечных
   - Разделение на подопечных с геолокацией и без
   - Фильтрация по статусу вызовов

2. **Интеграция с вызовами**
   - Отображение вызовов без геолокации
   - Приоритетные маркеры для критичных вызовов
   - Переход к деталям вызова
   - Просмотр истории перемещений

3. **Автоматическое обновление**
   - Автообновление каждые 10 секунд
   - Ручное обновление по кнопке
   - Индикация статуса загрузки

## Архитектура

### Backend (Location Service)

**API Endpoints:**
- `POST /locations/wards/:wardId` - Запись геолокации
- `GET /locations/wards/:wardId/latest` - Последняя геолокация
- `GET /locations/wards/:wardId/history` - История перемещений
- `GET /locations/geofences` - Список геозон
- `POST /locations/geofences` - Создание геозоны

**Таблицы БД:**
- `locations` - История геолокаций
- `geofences` - Геозоны для подопечных

### Frontend

**Guardian App:**
- `src/api/location.api.ts` - API клиент
- `src/stores/location.ts` - Pinia store
- `src/components/WardLocationMap.vue` - Компонент карты
- Интеграция в `WardDetailView.vue`

**Dispatcher App:**
- `src/api/location.api.ts` - API клиент
- `src/stores/location.ts` - Pinia store
- `src/components/WardsLocationMap.vue` - Компонент карты всех подопечных
- Замена `MapView.vue` на новый компонент

## Компоненты

### WardLocationMap (Guardian App)

**Функции:**
- Отображение текущей геолокации подопечного
- История перемещений с визуализацией пути
- Отображение геозон
- Управление отслеживанием
- Фильтрация истории по датам

**Пропсы:**
- `wardId: string` - ID подопечного
- `wardName: string` - Имя подопечного

### WardsLocationMap (Dispatcher App)

**Функции:**
- Отображение всех подопечных с геолокацией
- Отображение вызовов без геолокации
- Фильтрация по статусу вызовов
- Автоматическое обновление
- Список подопечных в сайдбаре

## Использование

### В Guardian App

Компонент автоматически отображается на странице деталей подопечного:

```vue
<WardLocationMap :wardId="wardId" :wardName="wardName" />
```

### В Dispatcher App

Компонент используется как основная карта:

```vue
<WardsLocationMap />
```

## API Использование

### Получение последней геолокации

```typescript
import { locationApi } from '@/api/location.api';

const location = await locationApi.getLatestLocation(wardId);
```

### Получение истории

```typescript
const history = await locationApi.getLocationHistory(wardId, {
  from: '2024-01-01',
  to: '2024-01-31',
  page: 1,
  limit: 100,
});
```

### Получение геозон

```typescript
const geofences = await locationApi.getGeofences(wardId);
```

## Трекинг в реальном времени

Store автоматически управляет обновлением геолокации:

```typescript
import { useLocationStore } from '@/stores/location';

const locationStore = useLocationStore();

// Начать отслеживание (обновление каждые 10 секунд)
locationStore.startTracking(wardId, 10000);

// Остановить отслеживание
locationStore.stopTracking(wardId);
```

## Визуализация

### Маркеры

- **Текущая геолокация** - Анимированный маркер с пульсацией
- **История** - Маленькие синие точки
- **Вызовы** - Цветные маркеры по приоритету
- **Геозоны** - Полупрозрачные круги

### Цвета приоритетов

- `critical` - Красный (#ef4444)
- `high` - Оранжевый (#f59e0b)
- `medium` - Синий (#3b82f6)
- `low` - Серый (#64748b)

## Multi-tenancy

Все запросы автоматически фильтруются по `organization_id` из JWT токена.

## Производительность

- Автоматическое обновление каждые 10 секунд
- Кэширование локаций в store
- Оптимизированные запросы к БД
- Индексы для быстрого поиска

## Безопасность

- JWT аутентификация для всех запросов
- Фильтрация по организации
- Валидация данных на backend
- Защита от SQL инъекций

## Следующие шаги (опционально)

1. **Уведомления о выходе из геозоны**
   - Автоматические уведомления при выходе из безопасной зоны
   - Push-уведомления опекунам

2. **Маршруты и прогнозы**
   - Построение маршрутов
   - Прогнозирование движения
   - Анализ паттернов перемещения

3. **Офлайн режим**
   - Кэширование локаций
   - Синхронизация при восстановлении связи

4. **Расширенная аналитика**
   - Статистика перемещений
   - Тепловые карты
   - Отчеты о перемещениях

---

**Функциональность полностью реализована и готова к использованию!** ✅







