# Руководство по безопасности (обновлено 2025-12-08)

Документация по мерам безопасности и best practices для системы Care Monitoring.

## Общие принципы безопасности

### Защита данных

1. **Шифрование в покое**
   - Чувствительные данные в БД шифруются
   - Использование `pgcrypto` для PostgreSQL
   - Шифрование бэкапов

2. **Шифрование в движении**
   - Обязательный HTTPS/TLS для всех соединений
   - TLS 1.2+ для внутренних сервисов
   - Валидация сертификатов

3. **Хранение секретов**
   - Никогда не коммитить секреты в репозиторий
   - Использование переменных окружения
   - Kubernetes Secrets или HashiCorp Vault для production

## Аутентификация и авторизация

### JWT/refresh
- Access TTL ≤ 15 мин, Refresh TTL ≤ 7–30 дней.
- Refresh httpOnly; ротация при каждом обмене.
- Инвалидация: logout, смена пароля, компрометация, отзыв устройства.

### RBAC (Role-Based Access Control)

**Роли и разрешения**:
```typescript
enum UserRole {
  WARD = 'ward',           // Подопечный - базовый доступ
  GUARDIAN = 'guardian',   // Опекун - доступ к данным подопечных
  DISPATCHER = 'dispatcher', // Диспетчер - доступ к вызовам
  ADMIN = 'admin'          // Администратор - полный доступ
}
```

**Проверка доступа**:
- На уровне API Gateway
- На уровне каждого микросервиса
- Проверка владения ресурсом (опекун может видеть только своих подопечных)

## Защита API

### Rate Limiting

```typescript
// Настройки rate limiting
const rateLimitConfig = {
  windowMs: 60 * 1000,  // 1 минута
  max: 100,              // 100 запросов
  message: 'Too many requests'
};
```

**Разные лимиты для разных endpoints**:
- Публичные endpoints: 100 req/min
- Аутентифицированные: 1000 req/min
- Критические (телеметрия): 10000 req/min

### Input Validation

- Валидация всех входных данных
- Использование class-validator
- Санитизация данных перед сохранением
- Защита от SQL injection через параметризованные запросы

### CORS
- Белый список origin через `CORS_ORIGIN`.
- credentials: true только при необходимости; методы/заголовки ограничены.

## Защита базы данных

### Базы данных
- Pooling, лимит коннектов, таймауты.
- TLS к БД; минимум прав для юзера сервиса.
- Параметризованные запросы / ORM без raw.
- Бэкапы: шифрование, регулярные тесты восстановления.

## Защита сообщений (RabbitMQ)

### RabbitMQ
- Отдельные пользователи/vhost на окружение, минимум прав.
- TLS к брокеру, ограничить доступ к UI; алерты на глубину очередей и отказ консьюмеров.

## Защита персональных данных

### Персональные данные
- Минимизация, анонимизация PII в логах/аналитике.
- Экспорт/удаление по запросу; аудит изменений.

## Защита устройств

### Устройства
- Уникальные ключи на устройство, отзыв при потере.
- TLS для телеметрии, контроль целостности, store-and-forward с seq/подписью.
- Подписанные прошивки, проверка подписи, откат.

## Мониторинг безопасности

### Аудит

**Логирование событий безопасности**:
- Входы в систему
- Изменения прав доступа
- Доступ к чувствительным данным
- Изменения конфигурации

**Хранение логов**:
- Централизованное хранение (Loki)
- Хранение минимум 90 дней
- Защита от модификации

### Обнаружение аномалий

**Метрики для мониторинга**:
- Количество неудачных попыток входа
- Необычные паттерны доступа
- Подозрительная активность API
- Аномалии в использовании ресурсов

**Алерты**:
- Более 5 неудачных попыток входа за 5 минут
- Доступ с необычных IP адресов
- Массовые запросы к API
- Изменения в критических конфигурациях

## Инцидент-менеджмент

### Инцидент-менеджмент
- Изоляция → диагностика → патч/ротация секретов и токенов → постмортем и action items.

### Контакты

- **Security Team**: security@caremonitoring.ru
- **Emergency**: +7-XXX-XXX-XX-XX
- **Bug Bounty**: security@caremonitoring.ru

## Регулярные проверки

### Регулярные проверки
- Еженедельно: обновления зависимостей, проверка бэкапов, просмотр security-логов.
- Ежемесячно: обзор доступов, аудит конфигов, тест восстановления.
- Ежеквартально: pentest, code security review, обновление политик.

## Compliance

### Медицинские данные

- Соответствие требованиям защиты медицинских данных
- Шифрование медицинской информации
- Ограниченный доступ к медицинским данным

### Платежные данные

- PCI DSS compliance (если храним карты)
- Использование токенизации
- Интеграция с PCI-compliant провайдерами

## Best Practices для разработчиков

### Best Practices (dev/ops)
- Secret handling: только env/secret store; не логировать секреты/PII.
- TLS everywhere; CORS whitelist; rate limiting на gateway.
- Static/dynamic scans в CI (npm audit/trivy/semgrep); обновлять base images.

## Чеклист безопасности

### При разработке

- [ ] Все секреты через env/secret store, нет секретов в репо.
- [ ] HTTPS/TLS, HSTS/CSP/CORS настроены.
- [ ] Rate limiting на gateway; brute-force защита login.
- [ ] Input validation и RBAC/tenant isolation.
- [ ] Логи без PII, с correlation-id, в централизованном хранилище.
- [ ] Бэкапы зашифрованы, проверка восстановления.
- [ ] Security сканы в CI (deps + docker + SAST).

