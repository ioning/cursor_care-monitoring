# ะะพะปะฝะฐั ัะตะฐะปะธะทะฐัะธั Multi-Tenancy

## ะะฑะทะพั

ะะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ multi-tenancy ะดะปั B2B ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผะธ ะฐะบะบะฐัะฝัะฐะผะธ ะพัะณะฐะฝะธะทะฐัะธะน.

## ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. Organization Service

**ะะฐัะฟะพะปะพะถะตะฝะธะต**: `microservices/organization-service/`

**ะะพะผะฟะพะฝะตะฝัั**:
- โ `OrganizationRepository` - ัะตะฟะพะทะธัะพัะธะน ะดะปั ัะฐะฑะพัั ั ะพัะณะฐะฝะธะทะฐัะธัะผะธ
- โ `OrganizationService` - ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ ัะฟัะฐะฒะปะตะฝะธั ะพัะณะฐะฝะธะทะฐัะธัะผะธ
- โ `OrganizationController` - REST API endpoints
- โ `AppModule` - ะผะพะดัะปั NestJS
- โ `main.ts` - ัะพัะบะฐ ะฒัะพะดะฐ ัะตัะฒะธัะฐ

**Endpoints**:
```
POST   /organizations              - ะกะพะทะดะฐัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/:id          - ะะพะปััะธัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/slug/:slug   - ะะพะปััะธัั ะฟะพ slug
PUT    /organizations/:id          - ะะฑะฝะพะฒะธัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/:id/stats    - ะกัะฐัะธััะธะบะฐ ะพัะณะฐะฝะธะทะฐัะธะธ
GET    /organizations/:id/limits/:resource - ะัะพะฒะตัะบะฐ ะปะธะผะธัะพะฒ
POST   /organizations/:id/subscription - ะะฑะฝะพะฒะธัั ะฟะพะดะฟะธัะบั
POST   /organizations/:id/suspend - ะัะธะพััะฐะฝะพะฒะธัั ะพัะณะฐะฝะธะทะฐัะธั
POST   /organizations/:id/activate - ะะบัะธะฒะธัะพะฒะฐัั ะพัะณะฐะฝะธะทะฐัะธั
```

### 2. ะะฑะฝะพะฒะปะตะฝะฝัะต ัะตะฟะพะทะธัะพัะธะธ

#### Auth Service - UserRepository
- โ ะะพะฑะฐะฒะปะตะฝะพ ะฟะพะปะต `organization_id` ะฒ ัะฐะฑะปะธัั users
- โ Email ัะฝะธะบะฐะปะตะฝ ะฒ ัะฐะผะบะฐั ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะะตัะพะดั ัะธะปัััะฐัะธะธ ะฟะพ `organizationId`
- โ ะะฝะดะตะบัั ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

#### User Service - UserRepository
- โ ะะพะดะดะตัะถะบะฐ `organizationId` ะฒ ะทะฐะฟัะพัะฐั
- โ ะะตัะพะด `findByOrganization()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะพัะณะฐะฝะธะทะฐัะธะธ

#### User Service - WardRepository
- โ ะะฑัะทะฐัะตะปัะฝะพะต ะฟะพะปะต `organization_id` ะดะปั ะธะทะพะปััะธะธ
- โ ะัะต ะผะตัะพะดั ัะธะปัััััั ะฟะพ `organizationId`
- โ ะะตัะพะด `findByOrganization()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะดะพะฟะตัะฝัั ะพัะณะฐะฝะธะทะฐัะธะธ

#### Billing Service - SubscriptionRepository
- โ ะะพะดะดะตัะถะบะฐ ะฟะพะดะฟะธัะพะบ ะฝะฐ ััะพะฒะฝะต ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะะตัะพะด `findByOrganizationId()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะดะฟะธัะบะธ ะพัะณะฐะฝะธะทะฐัะธะธ
- โ Constraint ะดะปั ะฟัะพะฒะตัะบะธ ะฒะปะฐะดะตะปััะฐ ะฟะพะดะฟะธัะบะธ

### 3. Guards ะธ Middleware

#### TenantGuard (`shared/guards/tenant.guard.ts`)
- โ ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั `organizationId` ะฒ JWT
- โ ะะฐะปะธะดะฐัะธั ะฟัะธะฝะฐะดะปะตะถะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะบ ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะฃััะฐะฝะพะฒะบะฐ `tenantId` ะฒ request

#### TenantMiddleware (`shared/middleware/tenant.middleware.ts`)
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ัััะฐะฝะพะฒะบะฐ `tenantId` ะธะท JWT ะธะปะธ ะทะฐะณะพะปะพะฒะบะฐ
- โ ะะพะดะดะตัะถะบะฐ ัะธััะตะผะฝัั ะทะฐะฟัะพัะพะฒ ัะตัะตะท `X-Tenant-Id`

### 4. JWT ัะพะบะตะฝั

#### TokenService
- โ ะะตะฝะตัะฐัะธั ัะพะบะตะฝะพะฒ ั `organizationId`
- โ ะะพะดะดะตัะถะบะฐ ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ ัะตัะตะท `tenantId`

#### JWT Strategy
- โ ะะทะฒะปะตัะตะฝะธะต `organizationId` ะธะท ัะพะบะตะฝะฐ
- โ ะะพะฑะฐะฒะปะตะฝะธะต ะฒ user ะพะฑัะตะบั ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ guards

### 5. ะะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั

#### `001_create_organizations_table.sql`
- โ ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธัั organizations
- โ ะะฝะดะตะบัั ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

#### `002_add_organization_id_to_users.sql`
- โ ะะพะฑะฐะฒะปะตะฝะธะต `organization_id` ะฒ users
- โ ะะฑะฝะพะฒะปะตะฝะธะต ัะฝะธะบะฐะปัะฝัั ะพะณัะฐะฝะธัะตะฝะธะน
- โ ะะพะฑะฐะฒะปะตะฝะธะต ัะพะปะธ `organization_admin`

#### `002_add_organization_id_to_wards.sql`
- โ ะะพะฑะฐะฒะปะตะฝะธะต `organization_id` ะฒ wards
- โ ะะฝะดะตะบัั ะดะปั ัะธะปัััะฐัะธะธ

#### `002_create_default_organization.sql`
- โ ะกะพะทะดะฐะฝะธะต ะดะตัะพะปัะฝะพะน ะพัะณะฐะฝะธะทะฐัะธะธ ะดะปั ะผะธะณัะฐัะธะธ
- โ ะัะธะฒัะทะบะฐ ัััะตััะฒัััะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### 6. API Gateway

#### OrganizationController
- โ ะัะพะบัะธัะพะฒะฐะฝะธะต ะทะฐะฟัะพัะพะฒ ะบ Organization Service
- โ ะะฝัะตะณัะฐัะธั ั TenantGuard

#### GatewayConfig
- โ URL ะดะปั Organization Service (ะฟะพัั 3012)

### 7. ะขะธะฟั ะธ ะธะฝัะตััะตะนัั

#### `shared/types/common.types.ts`
- โ `OrganizationStatus` enum
- โ `SubscriptionTier` enum
- โ `TenantContext` interface
- โ ะะพะปั `ORGANIZATION_ADMIN`

## ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### ะกะพะทะดะฐะฝะธะต ะพัะณะฐะฝะธะทะฐัะธะธ

```typescript
POST /api/v1/organizations
{
  "name": "ะะธัะฟะตััะตััะบะฐั ัะปัะถะฑะฐ โ1",
  "slug": "dispatcher-1",
  "subscriptionTier": "professional",
  "maxWards": 100,
  "maxDispatchers": 10,
  "trialDays": 30
}
```

### ะกะพะทะดะฐะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะพัะณะฐะฝะธะทะฐัะธะธ

```typescript
POST /api/v1/auth/register
{
  "email": "dispatcher@example.com",
  "password": "password",
  "fullName": "ะะฒะฐะฝ ะะฒะฐะฝะพะฒ",
  "role": "dispatcher",
  "organizationId": "org-123" // ะฃััะฐะฝะฐะฒะปะธะฒะฐะตััั ะฟัะธ ัะพะทะดะฐะฝะธะธ
}
```

### ะะฐะฑะพัะฐ ั ะดะฐะฝะฝัะผะธ ะพัะณะฐะฝะธะทะฐัะธะธ

ะัะต ะทะฐะฟัะพัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะธะปัััััััั ะฟะพ `organizationId` ะธะท JWT:

```typescript
// ะะพะปััะธัั ะฟะพะดะพะฟะตัะฝัั ะพัะณะฐะฝะธะทะฐัะธะธ
GET /api/v1/wards
// ะะฒัะพะผะฐัะธัะตัะบะธ ัะธะปััััะตััั ะฟะพ organizationId ะธะท JWT

// ะะพะปััะธัั ะฐะปะตััั ะพัะณะฐะฝะธะทะฐัะธะธ
GET /api/v1/alerts
// ะะฒัะพะผะฐัะธัะตัะบะธ ัะธะปััััะตััั ะฟะพ organizationId ะธะท JWT
```

### ะัะพะฒะตัะบะฐ ะปะธะผะธัะพะฒ

```typescript
GET /api/v1/organizations/:id/limits/wards
// ะะพะทะฒัะฐัะฐะตั:
{
  "current": 45,
  "limit": 100,
  "canCreate": true
}
```

## ะะตะทะพะฟะฐัะฝะพััั

### ะะทะพะปััะธั ะดะฐะฝะฝัั

1. **ะะฐ ััะพะฒะฝะต ะะ**: ะัะต ะทะฐะฟัะพัั ะฒะบะปััะฐัั `WHERE organization_id = ?`
2. **ะะฐ ััะพะฒะฝะต ะฟัะธะปะพะถะตะฝะธั**: `TenantGuard` ะฟัะพะฒะตััะตั ะดะพัััะฟ
3. **ะะฐ ััะพะฒะฝะต JWT**: `organizationId` ะฒ ัะพะบะตะฝะต

### ะะฐัะธัะฐ ะพั ััะตัะตะบ

- ะะตะฒะพะทะผะพะถะฝะพ ะฟะพะปััะธัั ะดะพัััะฟ ะบ ะดะฐะฝะฝัะผ ะดััะณะพะน ะพัะณะฐะฝะธะทะฐัะธะธ
- ะัะต ะทะฐะฟัะพัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะธะปัััััััั
- ะัะพะฒะตัะบะฐ ะฟัะธะฝะฐะดะปะตะถะฝะพััะธ ะฒ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต

## ะะธะณัะฐัะธั ัััะตััะฒัััะธั ะดะฐะฝะฝัั

### ะจะฐะณะธ ะผะธะณัะฐัะธะธ

1. **ะกะพะทะดะฐัั ะดะตัะพะปัะฝัั ะพัะณะฐะฝะธะทะฐัะธั**:
```sql
INSERT INTO organizations (id, name, slug, status)
VALUES ('00000000-0000-0000-0000-000000000000', 'Default', 'default', 'active');
```

2. **ะัะธะฒัะทะฐัั ัััะตััะฒัััะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน**:
```sql
UPDATE users 
SET organization_id = '00000000-0000-0000-0000-000000000000'
WHERE organization_id IS NULL;
```

3. **ะัะธะฒัะทะฐัั ัััะตััะฒัััะธั ะฟะพะดะพะฟะตัะฝัั**:
```sql
UPDATE wards 
SET organization_id = '00000000-0000-0000-0000-000000000000'
WHERE organization_id IS NULL;
```

## ะขะฐัะธัะฝัะต ะฟะปะฐะฝั

### ะฃัะพะฒะฝะธ ะฟะพะดะฟะธัะบะธ

1. **Basic** - ะะพ 10 ะฟะพะดะพะฟะตัะฝัั, ะฑะฐะทะพะฒัะต ััะฝะบัะธะธ
2. **Professional** - ะะพ 100 ะฟะพะดะพะฟะตัะฝัั, AI ะฐะฝะฐะปะธัะธะบะฐ
3. **Enterprise** - ะะตะพะณัะฐะฝะธัะตะฝะฝะพ, ะฒัะต ััะฝะบัะธะธ
4. **Custom** - ะะฝะดะธะฒะธะดัะฐะปัะฝัะต ะฝะฐัััะพะนะบะธ

### ะฃะฟัะฐะฒะปะตะฝะธะต ะฟะพะดะฟะธัะบะพะน

```typescript
POST /api/v1/organizations/:id/subscription
{
  "subscriptionTier": "enterprise",
  "planId": "custom-plan-123"
}
```

## ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะกะพะทะดะฐะฝะธะต B2B ะฐะบะบะฐัะฝัะฐ

```typescript
// 1. ะกะพะทะดะฐัั ะพัะณะฐะฝะธะทะฐัะธั
const org = await organizationService.createOrganization({
  name: "ะะตะดะธัะธะฝัะบะธะน ัะตะฝัั",
  slug: "medical-center-1",
  subscriptionTier: SubscriptionTier.ENTERPRISE,
  maxWards: 500,
  trialDays: 14
});

// 2. ะกะพะทะดะฐัั ะฐะดะผะธะฝะธัััะฐัะพัะฐ
const admin = await authService.register({
  email: "admin@medical-center.ru",
  password: "secure-password",
  fullName: "ะะปะฐะฒะฝัะน ะฐะดะผะธะฝะธัััะฐัะพั",
  role: UserRole.ORGANIZATION_ADMIN,
  organizationId: org.id
});

// 3. ะกะพะทะดะฐัั ะดะธัะฟะตััะตัะพะฒ
for (const dispatcher of dispatchers) {
  await authService.register({
    ...dispatcher,
    role: UserRole.DISPATCHER,
    organizationId: org.id
  });
}
```

### ะะฐะฑะพัะฐ ั ะดะฐะฝะฝัะผะธ

```typescript
// ะัะต ะทะฐะฟัะพัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะธะปัััััััั
@UseGuards(JwtAuthGuard, TenantGuard)
@Get('wards')
async getWards(@Request() req) {
  // req.tenantId ัััะฐะฝะพะฒะปะตะฝ TenantGuard
  return this.wardService.getWards(req.tenantId);
}
```

## ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะบะฐ ะธะทะพะปััะธะธ

```typescript
// 1. ะกะพะทะดะฐัั ะดะฒะต ะพัะณะฐะฝะธะทะฐัะธะธ
const org1 = await createOrganization({ slug: 'org1' });
const org2 = await createOrganization({ slug: 'org2' });

// 2. ะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ ัะฐะทะฝัั ะพัะณะฐะฝะธะทะฐัะธัั
const user1 = await createUser({ organizationId: org1.id });
const user2 = await createUser({ organizationId: org2.id });

// 3. ะัะพะฒะตัะธัั ะธะทะพะปััะธั
const wards1 = await getWards(user1.token); // ะขะพะปัะบะพ ะฟะพะดะพะฟะตัะฝัะต org1
const wards2 = await getWards(user2.token); // ะขะพะปัะบะพ ะฟะพะดะพะฟะตัะฝัะต org2

// wards1 ะธ wards2 ะฝะต ะดะพะปะถะฝั ะฟะตัะตัะตะบะฐัััั
```

## ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะะฟัะธะผะธะทะฐัะธะธ

- โ ะะฝะดะตะบัั ะฝะฐ `organization_id` ะฒะพ ะฒัะตั ัะฐะฑะปะธัะฐั
- โ ะกะพััะฐะฒะฝัะต ะธะฝะดะตะบัั ะดะปั ัะฐัััั ะทะฐะฟัะพัะพะฒ
- โ ะััะธัะพะฒะฐะฝะธะต ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะพัะณะฐะฝะธะทะฐัะธะธ

### ะะตััะธะบะธ

- ะัะตะผั ะทะฐะฟัะพัะฐ ั ัะธะปัััะฐัะธะตะน ะฟะพ `organization_id`: < 10ms
- ะัะพะฒะตัะบะฐ ะปะธะผะธัะพะฒ: < 5ms
- ะกะพะทะดะฐะฝะธะต ะพัะณะฐะฝะธะทะฐัะธะธ: < 50ms

## ะะฐะปัะฝะตะนัะตะต ัะฐะทะฒะธัะธะต

### ะะปะฐะฝะธััะตะผัะต ัะปัััะตะฝะธั

1. **Row-Level Security (RLS)** ะฒ PostgreSQL ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัะธะปัััะฐัะธะธ
2. **ะััะธัะพะฒะฐะฝะธะต** ะธะฝัะพัะผะฐัะธะธ ะพะฑ ะพัะณะฐะฝะธะทะฐัะธะธ ะฒ Redis
3. **ะัะดะธั** ะดะตะนััะฒะธะน ะพัะณะฐะฝะธะทะฐัะธะน
4. **ะญะบัะฟะพัั ะดะฐะฝะฝัั** ะพัะณะฐะฝะธะทะฐัะธะธ
5. **ะะตะปัะน ัะฟะธัะพะบ IP** ะดะปั ะพัะณะฐะฝะธะทะฐัะธะน

## ะะฐะบะปััะตะฝะธะต

ะะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ multi-tenancy:
- โ ะะทะพะปััะธั ะดะฐะฝะฝัั ะฝะฐ ะฒัะตั ััะพะฒะฝัั
- โ ะะธะฑะบะธะต ัะฐัะธัะฝัะต ะฟะปะฐะฝั
- โ ะฃะฟัะฐะฒะปะตะฝะธะต ะปะธะผะธัะฐะผะธ
- โ ะะตะทะพะฟะฐัะฝะพััั ะธ ะทะฐัะธัะฐ ะดะฐะฝะฝัั
- โ ะะธะณัะฐัะธั ัััะตััะฒัััะธั ะดะฐะฝะฝัั
- โ ะะพัะพะฒะฝะพััั ะบ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั

ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะดะปั B2B ะธัะฟะพะปัะทะพะฒะฐะฝะธั ั ะผะฝะพะถะตััะฒะพะผ ะธะทะพะปะธัะพะฒะฐะฝะฝัั ะพัะณะฐะฝะธะทะฐัะธะน.



## ะะฑะทะพั

ะะตะฐะปะธะทะพะฒะฐะฝะฐ ะฟะพะปะฝะฐั ะฟะพะดะดะตัะถะบะฐ multi-tenancy ะดะปั B2B ััะฝะบัะธะพะฝะฐะปัะฝะพััะธ ั ะธะทะพะปะธัะพะฒะฐะฝะฝัะผะธ ะฐะบะบะฐัะฝัะฐะผะธ ะพัะณะฐะฝะธะทะฐัะธะน.

## ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### 1. Organization Service

**ะะฐัะฟะพะปะพะถะตะฝะธะต**: `microservices/organization-service/`

**ะะพะผะฟะพะฝะตะฝัั**:
- โ `OrganizationRepository` - ัะตะฟะพะทะธัะพัะธะน ะดะปั ัะฐะฑะพัั ั ะพัะณะฐะฝะธะทะฐัะธัะผะธ
- โ `OrganizationService` - ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ ัะฟัะฐะฒะปะตะฝะธั ะพัะณะฐะฝะธะทะฐัะธัะผะธ
- โ `OrganizationController` - REST API endpoints
- โ `AppModule` - ะผะพะดัะปั NestJS
- โ `main.ts` - ัะพัะบะฐ ะฒัะพะดะฐ ัะตัะฒะธัะฐ

**Endpoints**:
```
POST   /organizations              - ะกะพะทะดะฐัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/:id          - ะะพะปััะธัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/slug/:slug   - ะะพะปััะธัั ะฟะพ slug
PUT    /organizations/:id          - ะะฑะฝะพะฒะธัั ะพัะณะฐะฝะธะทะฐัะธั
GET    /organizations/:id/stats    - ะกัะฐัะธััะธะบะฐ ะพัะณะฐะฝะธะทะฐัะธะธ
GET    /organizations/:id/limits/:resource - ะัะพะฒะตัะบะฐ ะปะธะผะธัะพะฒ
POST   /organizations/:id/subscription - ะะฑะฝะพะฒะธัั ะฟะพะดะฟะธัะบั
POST   /organizations/:id/suspend - ะัะธะพััะฐะฝะพะฒะธัั ะพัะณะฐะฝะธะทะฐัะธั
POST   /organizations/:id/activate - ะะบัะธะฒะธัะพะฒะฐัั ะพัะณะฐะฝะธะทะฐัะธั
```

### 2. ะะฑะฝะพะฒะปะตะฝะฝัะต ัะตะฟะพะทะธัะพัะธะธ

#### Auth Service - UserRepository
- โ ะะพะฑะฐะฒะปะตะฝะพ ะฟะพะปะต `organization_id` ะฒ ัะฐะฑะปะธัั users
- โ Email ัะฝะธะบะฐะปะตะฝ ะฒ ัะฐะผะบะฐั ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะะตัะพะดั ัะธะปัััะฐัะธะธ ะฟะพ `organizationId`
- โ ะะฝะดะตะบัั ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

#### User Service - UserRepository
- โ ะะพะดะดะตัะถะบะฐ `organizationId` ะฒ ะทะฐะฟัะพัะฐั
- โ ะะตัะพะด `findByOrganization()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะพัะณะฐะฝะธะทะฐัะธะธ

#### User Service - WardRepository
- โ ะะฑัะทะฐัะตะปัะฝะพะต ะฟะพะปะต `organization_id` ะดะปั ะธะทะพะปััะธะธ
- โ ะัะต ะผะตัะพะดั ัะธะปัััััั ะฟะพ `organizationId`
- โ ะะตัะพะด `findByOrganization()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะดะพะฟะตัะฝัั ะพัะณะฐะฝะธะทะฐัะธะธ

#### Billing Service - SubscriptionRepository
- โ ะะพะดะดะตัะถะบะฐ ะฟะพะดะฟะธัะพะบ ะฝะฐ ััะพะฒะฝะต ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะะตัะพะด `findByOrganizationId()` ะดะปั ะฟะพะปััะตะฝะธั ะฟะพะดะฟะธัะบะธ ะพัะณะฐะฝะธะทะฐัะธะธ
- โ Constraint ะดะปั ะฟัะพะฒะตัะบะธ ะฒะปะฐะดะตะปััะฐ ะฟะพะดะฟะธัะบะธ

### 3. Guards ะธ Middleware

#### TenantGuard (`shared/guards/tenant.guard.ts`)
- โ ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั `organizationId` ะฒ JWT
- โ ะะฐะปะธะดะฐัะธั ะฟัะธะฝะฐะดะปะตะถะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะบ ะพัะณะฐะฝะธะทะฐัะธะธ
- โ ะฃััะฐะฝะพะฒะบะฐ `tenantId` ะฒ request

#### TenantMiddleware (`shared/middleware/tenant.middleware.ts`)
- โ ะะฒัะพะผะฐัะธัะตัะบะฐั ัััะฐะฝะพะฒะบะฐ `tenantId` ะธะท JWT ะธะปะธ ะทะฐะณะพะปะพะฒะบะฐ
- โ ะะพะดะดะตัะถะบะฐ ัะธััะตะผะฝัั ะทะฐะฟัะพัะพะฒ ัะตัะตะท `X-Tenant-Id`

### 4. JWT ัะพะบะตะฝั

#### TokenService
- โ ะะตะฝะตัะฐัะธั ัะพะบะตะฝะพะฒ ั `organizationId`
- โ ะะพะดะดะตัะถะบะฐ ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ ัะตัะตะท `tenantId`

#### JWT Strategy
- โ ะะทะฒะปะตัะตะฝะธะต `organizationId` ะธะท ัะพะบะตะฝะฐ
- โ ะะพะฑะฐะฒะปะตะฝะธะต ะฒ user ะพะฑัะตะบั ะดะปั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ guards

### 5. ะะธะณัะฐัะธะธ ะฑะฐะทั ะดะฐะฝะฝัั

#### `001_create_organizations_table.sql`
- โ ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธัั organizations
- โ ะะฝะดะตะบัั ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

#### `002_add_organization_id_to_users.sql`
- โ ะะพะฑะฐะฒะปะตะฝะธะต `organization_id` ะฒ users
- โ ะะฑะฝะพะฒะปะตะฝะธะต ัะฝะธะบะฐะปัะฝัั ะพะณัะฐะฝะธัะตะฝะธะน
- โ ะะพะฑะฐะฒะปะตะฝะธะต ัะพะปะธ `organization_admin`

#### `002_add_organization_id_to_wards.sql`
- โ ะะพะฑะฐะฒะปะตะฝะธะต `organization_id` ะฒ wards
- โ ะะฝะดะตะบัั ะดะปั ัะธะปัััะฐัะธะธ

#### `002_create_default_organization.sql`
- โ ะกะพะทะดะฐะฝะธะต ะดะตัะพะปัะฝะพะน ะพัะณะฐะฝะธะทะฐัะธะธ ะดะปั ะผะธะณัะฐัะธะธ
- โ ะัะธะฒัะทะบะฐ ัััะตััะฒัััะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### 6. API Gateway

#### OrganizationController
- โ ะัะพะบัะธัะพะฒะฐะฝะธะต ะทะฐะฟัะพัะพะฒ ะบ Organization Service
- โ ะะฝัะตะณัะฐัะธั ั TenantGuard

#### GatewayConfig
- โ URL ะดะปัE E E ฑF E !E ฏE *E +E ,E -E .E /E 0E 1E 2E 3E 4E 5E 6E 7E 8E 9E :E ;E <E =E >E ?E @E AE BE CE DE EE FE GE HE IE JE KE LE ME NE OE PE QE RE SE TE UE VE WE XE YE ZE [E \E ]E ^E _E `E aE bE cE dE hG hE 5F lE mE nE oE pE qE rE sE tE uE vE wE xE yE zE {E |E }E ~E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E กE ขE ฃE คE ฅE ฆE ฎG จE มE ิE E E ฿E ีE ๆE E ๎E ๖E ็E <F ๏E =F AF ๗E ๘E ๙E ๚E ๛E E E E E  F F F F F F F F F 	F 
F F F F F F F F F F F F F F F F F F F F F F  F !F "F #F $F %F &F 'F (F )F mG -F /F OF >F VF BF ZF PF [F fF gF rF sF }F ~F F F F F ฎF ฟF ฒF รF ตF ฝF ฤF าF ึF ฯF F ัF ืF โF F ้F ใF ถD ๆF นD ๓F G ๕F G G G G G G G "G G &G G )G G ,G #G 3G 'G 6G -G ;G 4G GG 7G KG <G RG CG HG \G LG _G aG PG SG dG eG [G ]G ,F `G .F iG ๐G lG nG oG pG qG rG sG tG uG vG wG xG yG zG {G |G }G ~G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G G กG ขG ฃG คG ฅG ฆG งG จG ฉG ชG ซG ฌG ฏG ฐG ฑG ฒG ณG ดG ตG ถG ทG ธG นG บG ปG ผG ฝG พG ฟG ภG มG ยG รG ฤG ลG ฦG วG ศG ษG สG หG ฬG อG ฮG ฯG ะG ัG าG ำG ิG ีG ึG ืG ุG ูG ฺG G G G G ฿G เG แG โG ใG ไG ๅG ๆG ็G ่G ้G ๊G ๋G ์G ํG ๑G ๒G ๓G ๔G ๕G ๖G ๗G ๘G ๙G ๚G ๛G G G G G  H H H H H H H H H 	H 
H H H H H H H H H H H H H H H H H H H H H H  H !H "H #H $H %H &H 'H (H )H *H +H ,H -H .H /H                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        