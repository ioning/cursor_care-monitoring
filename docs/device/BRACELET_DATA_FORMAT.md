# Формат данных от браслета (Bracelet Device)

## Обзор

Браслет отправляет данные телеметрии через API Gateway на endpoint `/api/v1/telemetry` с использованием API ключа устройства.

**Особенности устройства:**
- **Измеряет:** пульс (heart_rate), насыщение кислородом (spo2), температуру (temperature), шаги (steps), уровень батареи (battery)
- **Обнаруживает:** падения (fall_detected)
- **Не измеряет:** давление (blood_pressure)
- **Не имеет GPS:** местоположение определяется мобильным приложением через встроенный модуль телефона (GPS/сеть)

## Аутентификация

Браслет использует **API Key** для аутентификации. API ключ выдается при регистрации устройства и передается в заголовке:

```
X-API-Key: <api_key>
```

**Важно:** В текущей реализации используется JWT токен через заголовок `Authorization: Bearer <token>`. Для устройств без пользователя нужно использовать API Key аутентификацию.

## Endpoint

```
POST /api/v1/telemetry
```

## Формат запроса

### Структура JSON

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "heart_rate",
      "value": 72,
      "unit": "bpm",
      "qualityScore": 0.95,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "spo2",
      "value": 98,
      "unit": "%",
      "qualityScore": 0.92,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "temperature",
      "value": 36.6,
      "unit": "c",
      "qualityScore": 0.97,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "steps",
      "value": 1240,
      "unit": "count",
      "qualityScore": 0.90,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "battery",
      "value": 85,
      "unit": "%",
      "qualityScore": 1.0,
      "timestamp": "2025-12-25T10:30:00.000Z"
    }
  ],
  "location": {
    "latitude": 55.7558,
    "longitude": 37.6173,
    "accuracy": 10,
    "source": "gps"
  }
}
```

## Описание полей

### Обязательные поля

#### `deviceId` (string, обязательное)
- UUID устройства, полученный при регистрации
- Пример: `"11111111-1111-1111-1111-111111111111"`

#### `metrics` (array, обязательное)
- Массив метрик телеметрии
- Минимум 1 метрика
- Каждая метрика должна содержать `type` и `value`

### Поля метрики (`metrics[]`)

#### `type` (string, обязательное)
Тип метрики. Поддерживаемые типы:

- **`heart_rate`** - Пульс (удары в минуту)
- **`spo2`** - Насыщение крови кислородом (проценты)
- **`temperature`** - Температура тела (°C)
- **`steps`** - Количество шагов (count)
- **`battery`** - Уровень заряда батареи (%)
- **`fall_detected`** - Обнаружение падения (1 = обнаружено, 0 = нет)
- **`activity`** - Уровень активности (произвольная единица)

**Примечание:** Давление (blood_pressure_*) не измеряется браслетом и не должно отправляться.

#### `value` (number, обязательное)
- Числовое значение метрики
- Тип зависит от метрики (целое или дробное)

#### `unit` (string, опциональное)
- Единица измерения
- Примеры: `"bpm"`, `"%"`, `"c"`, `"count"`

#### `qualityScore` (number, опциональное)
- Оценка качества данных от 0.0 до 1.0
- `1.0` = отличное качество
- `0.0` = плохое качество
- Используется для фильтрации недостоверных данных

#### `timestamp` (string, опциональное)
- ISO 8601 временная метка
- Формат: `"2025-12-25T10:30:00.000Z"`
- Если не указано, используется время получения запроса на сервере

### Поля местоположения (`location`, опциональное)

**Важно:** Браслет не имеет встроенного GPS модуля. Местоположение определяется встроенным модулем телефона (мобильного приложения) и передается вместе с данными телеметрии.

#### `latitude` (number, обязательное если указано `location`)
- Широта в градусах
- Диапазон: -90 до 90
- Пример: `55.7558`
- Получается от мобильного приложения через GPS/сеть телефона

#### `longitude` (number, обязательное если указано `location`)
- Долгота в градусах
- Диапазон: -180 до 180
- Пример: `37.6173`
- Получается от мобильного приложения через GPS/сеть телефона

#### `accuracy` (number, опциональное)
- Точность определения местоположения в метрах
- Пример: `10` (точность ±10 метров)
- Определяется мобильным приложением

#### `source` (string, обязательное если указано `location`)
- Источник данных о местоположении
- Возможные значения:
  - `"gps"` - GPS модуль телефона
  - `"network"` - Сетевое местоположение телефона (Wi-Fi, сотовая связь)
  - `"manual"` - Введено вручную в мобильном приложении

## Примеры запросов

### Минимальный запрос (только пульс)

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "heart_rate",
      "value": 72,
      "unit": "bpm"
    }
  ]
}
```

### Полный запрос со всеми метриками

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "heart_rate",
      "value": 72,
      "unit": "bpm",
      "qualityScore": 0.95,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "spo2",
      "value": 98,
      "unit": "%",
      "qualityScore": 0.92,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "temperature",
      "value": 36.6,
      "unit": "c",
      "qualityScore": 0.97,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "steps",
      "value": 1240,
      "unit": "count",
      "qualityScore": 0.90,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
     {
       "type": "battery",
       "value": 85,
       "unit": "%",
       "qualityScore": 1.0,
       "timestamp": "2025-12-25T10:30:00.000Z"
     }
  ],
  "location": {
    "latitude": 55.7558,
    "longitude": 37.6173,
    "accuracy": 10,
    "source": "gps"
  }
}
```

### Запрос с обнаружением падения

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "fall_detected",
      "value": 1,
      "unit": "count",
      "qualityScore": 0.95,
      "timestamp": "2025-12-25T10:30:00.000Z"
    },
    {
      "type": "heart_rate",
      "value": 95,
      "unit": "bpm",
      "qualityScore": 0.90,
      "timestamp": "2025-12-25T10:30:00.000Z"
    }
  ],
  "location": {
    "latitude": 55.7558,
    "longitude": 37.6173,
    "accuracy": 15,
    "source": "gps"
  }
}
```

**Примечание:** Местоположение получается от мобильного приложения (встроенный GPS/сеть телефона), а не от браслета.

## Формат ответа

### Успешный ответ (201 Created)

```json
{
  "success": true,
  "data": {
    "telemetryId": "550e8400-e29b-41d4-a716-446655440000",
    "deviceId": "11111111-1111-1111-1111-111111111111",
    "wardId": "dac6bf83-aa52-42af-80ea-9ba5204e83b5",
    "metricsCount": 5,
    "processedAt": "2025-12-25T10:30:00.500Z"
  }
}
```

### Ошибка валидации (400 Bad Request)

```json
{
  "statusCode": 400,
  "message": [
    "deviceId must be a string",
    "metrics must be an array",
    "metrics should not be empty"
  ],
  "error": "Bad Request"
}
```

### Ошибка аутентификации (401 Unauthorized)

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

### Устройство не найдено (404 Not Found)

```json
{
  "statusCode": 404,
  "message": "Device not found"
}
```

## Частота отправки данных

Рекомендуемая частота отправки данных:

- **Основные метрики** (heart_rate, spo2, temperature): каждые **15 минут**
- **Шаги** (steps): каждые **1 час** (накопительное значение)
- **Батарея** (battery): каждые **1 час**
- **Падение** (fall_detected): **немедленно** при обнаружении
- **Местоположение** (location): каждые **10 минут** или при изменении более чем на 10 метров (определяется мобильным приложением через GPS/сеть телефона)

## Типичные значения метрик

### Для пожилого человека (67 лет, гипертония)

- **heart_rate**: 60-85 bpm (днем), 55-75 bpm (ночью)
- **spo2**: 96-99%
- **temperature**: 36.2-37.0°C
- **steps**: 0-5000 шагов в день
- **battery**: 20-100%

**Примечание:** Давление не измеряется браслетом.

## Обработка на сервере

1. **Валидация**: Проверка формата данных
2. **Определение подопечного**: По `deviceId` определяется `wardId` через device-service
3. **Сохранение**: Данные сохраняются в `telemetry_db.raw_metrics`
4. **События**: Публикуется событие `telemetry.data.received` в RabbitMQ
5. **Обработка**: AI-prediction-service анализирует данные и генерирует предсказания
6. **Алерты**: Alert-service проверяет данные на аномалии и создает алерты при необходимости

## Пример cURL запроса

```bash
curl -X POST http://localhost:3000/api/v1/telemetry \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <jwt_token>" \
  -d '{
    "deviceId": "11111111-1111-1111-1111-111111111111",
    "metrics": [
      {
        "type": "heart_rate",
        "value": 72,
        "unit": "bpm",
        "qualityScore": 0.95
      },
      {
        "type": "spo2",
        "value": 98,
        "unit": "%",
        "qualityScore": 0.92
      }
    ]
  }'
```

## Примечания

1. **API Key аутентификация**: В текущей реализации используется JWT токен. Для устройств IoT рекомендуется добавить поддержку API Key аутентификации через заголовок `X-API-Key`.

2. **Буферизация**: Браслет должен буферизовать данные при отсутствии связи и отправлять их пакетами при восстановлении соединения.

3. **Сжатие**: Для экономии трафика можно использовать сжатие gzip (заголовок `Content-Encoding: gzip`).

4. **Таймауты**: Рекомендуемый таймаут запроса: 30 секунд.

5. **Retry логика**: При ошибке 5xx рекомендуется повторить запрос с экспоненциальной задержкой (1s, 2s, 4s, 8s).

---

**Последнее обновление:** 2025-12-25

