# Настройка аккаунта подопечного через SMS

## Обзор

При создании подопечного опекун указывает номер телефона, и система автоматически:
1. Создает аккаунт для подопечного
2. Генерирует временный пароль
3. Отправляет SMS с паролем на телефон подопечного

## Процесс создания подопечного

### 1. Опекун создает подопечного

**Endpoint:** `POST /api/v1/users/wards`

**Request:**
```json
{
  "fullName": "Иван Иванов",
  "phone": "+79001234567",
  "dateOfBirth": "1950-01-15",
  "gender": "male",
  "medicalInfo": "Диабет, аллергия на пенициллин",
  "emergencyContact": "+79009876543"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "ward-uuid",
    "fullName": "Иван Иванов",
    "phone": "+79001234567",
    ...
  },
  "message": "Ward created successfully",
  "accountCreated": true
}
```

### 2. Система автоматически:

1. **Создает запись в `wards`** с указанными данными
2. **Создает пользователя в `users`**:
   - ID: тот же UUID что и у ward
   - Email: автоматически генерируется `ward+79001234567@care-monitoring.ru`
   - Phone: `+79001234567`
   - Role: `ward`
   - Password: временный пароль (8 символов)
   - EmailVerified: `true` (пропускаем верификацию для подопечных)
3. **Генерирует временный пароль** (8 символов: буквы + цифры)
4. **Отправляет SMS** на номер подопечного с паролем

### 3. SMS сообщение

Подопечный получает SMS:
```
Care Monitoring: Для Иван Иванов создан аккаунт. 
Пароль: Abc12345. 
Скачайте приложение: https://care-monitoring.ru/app
```

## Генерация пароля

Пароль генерируется автоматически с требованиями:
- Длина: 8 символов
- Содержит: заглавные буквы, строчные буквы, цифры
- Гарантируется: минимум 1 цифра, 1 заглавная буква, 1 строчная буква

**Примеры паролей:**
- `Abc12345`
- `XyZ98765`
- `MnP45678`

## Генерация email

Email генерируется автоматически на основе номера телефона:
- Формат: `ward+<цифры_телефона>@care-monitoring.ru`
- Пример: `ward+79001234567@care-monitoring.ru`

**Особенности:**
- Все нецифровые символы удаляются из номера телефона
- Email уникален для каждого номера телефона
- Email автоматически помечается как верифицированный

## Вход подопечного в мобильное приложение

1. Подопечный открывает мобильное приложение
2. Вводит номер телефона: `+79001234567`
3. Вводит пароль из SMS: `Abc12345`
4. Входит в систему

**Примечание:** В мобильном приложении можно использовать:
- Номер телефона вместо email для входа
- Или сгенерированный email: `ward+79001234567@care-monitoring.ru`

## Архитектура

### Компоненты

1. **User Service** (`ward.service.ts`):
   - Создает запись в `wards`
   - Вызывает Auth Service для создания пользователя
   - Вызывает Integration Service для отправки SMS

2. **Auth Service** (`internal.controller.ts`):
   - Внутренний endpoint `/internal/users/ward`
   - Создает пользователя с указанным ID
   - Генерирует email на основе телефона
   - Пропускает верификацию email

3. **Integration Service** (`integration.controller.ts`):
   - Внутренний endpoint `/internal/sms/send`
   - Отправляет SMS через SMS.ru

### Клиенты

1. **AuthServiceClient** (`user-service`):
   - Вызывает `/internal/users/ward` в Auth Service
   - Fallback на `/auth/register` если внутренний endpoint недоступен

2. **IntegrationServiceClient** (`user-service`):
   - Вызывает `/internal/sms/send` в Integration Service
   - Логирует в development режиме если SMS не настроен

## Безопасность

1. **Внутренние endpoints защищены:**
   - Проверка заголовка `X-Internal-Service`
   - Разрешены только определенные сервисы

2. **Временные пароли:**
   - Генерируются случайным образом
   - Рекомендуется сменить при первом входе (функционал в разработке)

3. **Email верификация:**
   - Пропускается для подопечных (создаются опекуном)
   - Email помечается как верифицированный автоматически

## Обработка ошибок

1. **Если SMS не отправлен:**
   - Подопечный все равно создается
   - Ошибка логируется
   - Опекун может запросить повторную отправку (функционал в разработке)

2. **Если создание пользователя не удалось:**
   - Запись в `wards` все равно создается
   - Ошибка логируется
   - Опекун может создать аккаунт позже (функционал в разработке)

## Переменные окружения

### User Service
```env
AUTH_SERVICE_URL=http://localhost:3001
INTEGRATION_SERVICE_URL=http://localhost:3008
```

### Integration Service
```env
SMSRU_API_KEY=your-smsru-api-key
```

## Примеры использования

### Успешное создание подопечного с аккаунтом

```bash
POST /api/v1/users/wards
Authorization: Bearer <guardian_token>
Content-Type: application/json

{
  "fullName": "Иван Иванов",
  "phone": "+79001234567",
  "dateOfBirth": "1950-01-15"
}

# Результат:
# 1. Создается ward
# 2. Создается user с тем же ID
# 3. Генерируется пароль: Abc12345
# 4. Отправляется SMS на +79001234567
# 5. Подопечный может войти в мобильное приложение
```

### Создание подопечного без телефона

```bash
POST /api/v1/users/wards
{
  "fullName": "Иван Иванов",
  "dateOfBirth": "1950-01-15"
  # phone не указан
}

# Результат:
# 1. Создается только ward
# 2. Аккаунт НЕ создается
# 3. Опекун может создать аккаунт позже (функционал в разработке)
```

## Разработка и тестирование

### Development режим

В development режиме (`NODE_ENV=development`):
- Если SMS не настроен, пароль логируется в консоль
- Пароль возвращается в ответе API (только для тестирования)

### Тестирование

1. **Создать подопечного:**
   ```bash
   curl -X POST http://localhost:3000/api/v1/users/wards \
     -H "Authorization: Bearer <guardian_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "fullName": "Тестовый Подопечный",
       "phone": "+79001234567"
     }'
   ```

2. **Проверить SMS:**
   - Проверить логи Integration Service
   - Проверить SMS.ru панель (если настроено)

3. **Войти в мобильное приложение:**
   - Использовать номер телефона: `+79001234567`
   - Использовать пароль из SMS

## Будущие улучшения

1. ✅ Автоматическое создание аккаунта при создании подопечного
2. ✅ Отправка SMS с паролем
3. ⏳ Повторная отправка SMS (если не доставлено)
4. ⏳ Принудительная смена пароля при первом входе
5. ⏳ Создание аккаунта для существующего подопечного
6. ⏳ Отправка учетных данных опекуну по email (дублирование)

