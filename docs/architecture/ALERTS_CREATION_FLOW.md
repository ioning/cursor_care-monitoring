# Как создаются алерты по показателям здоровья и данным акселерометра

## Обзор

Система создания алертов работает в двух режимах:
1. **Немедленные алерты** - для критических метрик (fall_detected, критические значения здоровья)
2. **AI-предсказания** - анализ паттернов и предсказание рисков на основе множества факторов

## Поток данных

```
Браслет → API Gateway → TelemetryService
                              ↓
                    ┌─────────┴─────────┐
                    ↓                   ↓
            Критические метрики    Обычные метрики
                    ↓                   ↓
            AlertService         RabbitMQ (telemetry-queue)
            (немедленный алерт)         ↓
                                   AI Prediction Service
                                         ↓
                                   Анализ паттернов
                                         ↓
                              Если riskScore >= 0.7
                                         ↓
                              RabbitMQ (risk-alert-queue)
                                         ↓
                                   AlertService
                                   (AI-based alert)
```

## 1. Немедленные алерты (критические метрики)

### Обрабатываемые метрики

#### Fall Detection (fall_detected)
- **Тип метрики**: `fall_detected`
- **Значение**: `1` (обнаружено падение)
- **Severity**: `CRITICAL`
- **Действие**: Немедленное создание алерта без AI анализа

#### Критические показатели здоровья

**SpO2 (Насыщение кислородом)**
- `< 85%`: `CRITICAL` - Критическая гипоксия
- `< 90%`: `HIGH` - Низкое насыщение кислородом
- `< 94%`: `MEDIUM` - Пониженное насыщение

**Heart Rate (Пульс)**
- `> 120 bpm`: `HIGH` - Тахикардия
- `> 100 bpm`: `MEDIUM` - Повышенный пульс
- `< 40 bpm`: `CRITICAL` - Критическая брадикардия
- `< 50 bpm`: `HIGH` - Низкий пульс

**Temperature (Температура)**
- `> 38.5°C`: `HIGH` - Лихорадка
- `> 39°C`: `CRITICAL` - Высокая температура
- `< 35°C`: `CRITICAL` - Гипотермия

### Логика обработки

Критические метрики обрабатываются в `TelemetryService` при получении данных:

```typescript
// Проверка критических метрик
if (hasCriticalMetrics(metrics)) {
  // Немедленное создание алерта
  await createImmediateAlert(wardId, criticalMetric);
}
```

## 2. AI-предсказания (анализ паттернов)

### Модель Fall Prediction

AI Prediction Service анализирует комбинацию факторов для предсказания риска падения:

#### Веса факторов (Feature Weights)

| Фактор | Вес | Описание |
|--------|-----|----------|
| Activity | 0.25 | Уровень активности |
| Heart Rate | 0.20 | Паттерны пульса |
| Heart Rate Variability | 0.15 | Вариабельность пульса |
| Steps | 0.10 | Количество шагов |
| Accelerometer | 0.15 | Данные акселерометра |
| SpO2 | 0.05 | Насыщение кислородом |
| Time of Day | 0.05 | Время суток |
| Movement Pattern | 0.05 | Паттерны движения |

### Оценка факторов

#### Акселерометр (Accelerometer)
- **Магнитуда > 2g** (19.6 m/s²): `riskScore = 0.9` - Высокая вероятность падения
- **Магнитуда > 1.5g** (14.7 m/s²): `riskScore = 0.6` - Средняя вероятность
- **Резкое изменение > 0.5g**: `riskScore = 0.5` - Подозрительное движение

**Расчет магнитуды:**
```typescript
magnitude = √(acc_x² + acc_y² + acc_z²)
```

#### Пульс (Heart Rate)
- **> 120 bpm**: `riskScore = 0.7` - Тахикардия
- **> 100 bpm**: `riskScore = 0.4` - Повышенный пульс
- **< 40 bpm**: `riskScore = 0.9` - Критическая брадикардия
- **< 50 bpm**: `riskScore = 0.6` - Низкий пульс
- **Отклонение от baseline > 30%**: `riskScore = 0.3`

#### Активность (Activity)
- **< 0.1**: `riskScore = 0.8` - Очень низкая активность (возможно лежит)
- **< 0.2**: `riskScore = 0.5` - Низкая активность
- **< 0.3**: `riskScore = 0.2` - Пониженная активность
- **Резкое падение > 50%**: `riskScore = 0.6` - Внезапная остановка

#### Шаги (Steps)
- **< 10% от ожидаемого**: `riskScore = 0.6` - Очень мало шагов
- **< 30% от ожидаемого**: `riskScore = 0.3` - Мало шагов
- **Резкое падение > 50%**: `riskScore = 0.4` - Внезапное снижение активности

#### SpO2 (Насыщение кислородом)
- **< 85%**: `riskScore = 0.9` - Критическая гипоксия
- **< 90%**: `riskScore = 0.6` - Низкое насыщение
- **< 94%**: `riskScore = 0.3` - Пониженное насыщение

#### Вариабельность пульса (HRV)
- **< 20**: `riskScore = 0.5` - Низкая вариабельность (стресс)
- **< 30**: `riskScore = 0.3` - Пониженная вариабельность
- **> 100**: `riskScore = 0.2` - Очень высокая вариабельность

#### Время суток (Time of Day)
- **Ночь (22:00-6:00)**: `riskScore += 0.2` - Повышенный риск ночью
- **Раннее утро (4:00-6:00)**: `riskScore += 0.3` - Высокий риск

#### Паттерны движения (Movement Pattern)
- **Высокая вариативность (> 0.8)**: `riskScore = 0.4` - Нестабильность
- **Внезапная остановка**: `riskScore = 0.5` - Подозрительное поведение

### Определение Severity

На основе итогового `riskScore`:

| Risk Score | Severity | Описание |
|------------|----------|----------|
| < 0.25 | `low` | Низкий риск |
| 0.25 - 0.45 | `medium` | Средний риск |
| 0.45 - 0.70 | `high` | Высокий риск |
| ≥ 0.70 | `critical` | Критический риск → создается алерт |

### Порог создания алерта

- **Risk Threshold**: `0.7` (70%)
- Если `riskScore >= 0.7`, создается `RiskAlertEvent` → `AlertService` → создается алерт в БД

## 3. Обработка данных акселерометра

### Формат данных

Акселерометр может передаваться в двух форматах:

1. **Компоненты (x, y, z)**:
```json
{
  "type": "accelerometer_x",
  "value": 0.5,
  "unit": "g"
},
{
  "type": "accelerometer_y",
  "value": -0.2,
  "unit": "g"
},
{
  "type": "accelerometer_z",
  "value": 9.8,
  "unit": "g"
}
```

2. **Магнитуда (уже рассчитанная)**:
```json
{
  "type": "accelerometer_magnitude",
  "value": 9.85,
  "unit": "g"
}
```

### Расчет магнитуды

Если переданы компоненты, магнитуда рассчитывается автоматически:

```typescript
magnitude = Math.sqrt(
  Math.pow(accelX, 2) + 
  Math.pow(accelY, 2) + 
  Math.pow(accelZ, 2)
);
```

### Обнаружение падения

1. **Непосредственное обнаружение**: Если браслет отправляет `fall_detected = 1`, создается немедленный алерт
2. **AI-анализ**: Если магнитуда акселерометра > 2g, это увеличивает riskScore для предсказания падения

## 4. Примеры создания алертов

### Пример 1: Обнаружено падение (fall_detected)

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "fall_detected",
      "value": 1,
      "unit": "count",
      "timestamp": "2025-12-25T10:30:00.000Z"
    }
  ]
}
```

**Результат:**
- Немедленное создание алерта
- Severity: `CRITICAL`
- Alert Type: `fall_detected`
- Title: "Обнаружено падение"

### Пример 2: Критический SpO2

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "spo2",
      "value": 82,
      "unit": "%",
      "timestamp": "2025-12-25T10:30:00.000Z"
    }
  ]
}
```

**Результат:**
- Немедленное создание алерта
- Severity: `CRITICAL`
- Alert Type: `low_oxygen`
- Title: "Критическое снижение насыщения кислородом"

### Пример 3: AI-предсказание на основе акселерометра

```json
{
  "deviceId": "11111111-1111-1111-1111-111111111111",
  "metrics": [
    {
      "type": "accelerometer_x",
      "value": 5.2,
      "unit": "g"
    },
    {
      "type": "accelerometer_y",
      "value": -3.1,
      "unit": "g"
    },
    {
      "type": "accelerometer_z",
      "value": 8.5,
      "unit": "g"
    },
    {
      "type": "heart_rate",
      "value": 95,
      "unit": "bpm"
    },
    {
      "type": "activity",
      "value": 0.05,
      "unit": "ratio"
    }
  ]
}
```

**Расчет:**
- `magnitude = √(5.2² + (-3.1)² + 8.5²) = 10.3g` → `riskScore += 0.9 * 0.15 = 0.135`
- `activity = 0.05` → `riskScore += 0.8 * 0.25 = 0.2`
- `heart_rate = 95` → норма
- **Итого**: `riskScore ≈ 0.335` → Severity: `medium` → алерт не создается (ниже порога 0.7)

Но если добавить низкий SpO2:
- `spo2 = 88` → `riskScore += 0.6 * 0.05 = 0.03`
- **Итого**: `riskScore ≈ 0.365` → все еще ниже порога

Если добавить критический пульс:
- `heart_rate = 35` → `riskScore += 0.9 * 0.20 = 0.18`
- **Итого**: `riskScore ≈ 0.545` → Severity: `high`, но все еще ниже порога 0.7

## 5. Пороги и настройки

### Пороги для немедленных алертов

| Метрика | Критическое значение | Severity |
|---------|----------------------|----------|
| fall_detected | = 1 | CRITICAL |
| spo2 | < 85% | CRITICAL |
| spo2 | < 90% | HIGH |
| heart_rate | < 40 bpm | CRITICAL |
| heart_rate | < 50 bpm | HIGH |
| heart_rate | > 120 bpm | HIGH |
| temperature | < 35°C или > 39°C | CRITICAL |
| temperature | > 38.5°C | HIGH |

### Пороги для AI-предсказаний

- **Risk Threshold**: `0.7` (70%)
- **Confidence**: Зависит от количества доступных метрик (0.65 - 0.95)
- **Time Horizon**: Зависит от riskScore (5-15 минут для критического риска)

## 6. Файлы и компоненты

### TelemetryService
- `microservices/telemetry-service/src/application/services/telemetry.service.ts`
- Обрабатывает входящие данные телеметрии
- Публикует события в RabbitMQ

### AI Prediction Service
- `microservices/ai-prediction-service/src/application/services/ai-prediction.service.ts`
- Обрабатывает события телеметрии
- Извлекает features и запускает модель предсказания
- `microservices/ai-prediction-service/src/infrastructure/ml-models/fall-prediction.model.ts`
- Модель предсказания падений с весами факторов

### Alert Service
- `microservices/alert-service/src/application/services/alert.service.ts`
- Обрабатывает `RiskAlertEvent` от AI Prediction Service
- Создает алерты в БД
- Публикует события `alert.created`

## 7. Рекомендации по улучшению

1. **Добавить обработку критических метрик в TelemetryService** для немедленных алертов
2. **Улучшить обработку fall_detected** - создать отдельный тип алерта
3. **Добавить исторический контекст** для более точных предсказаний
4. **Настраиваемые пороги** через конфигурацию для разных типов пользователей

---

**Последнее обновление:** 2025-12-25

