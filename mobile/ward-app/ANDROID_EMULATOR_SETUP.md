# Настройка подключения Android эмулятора к API

## Проблема

При запуске мобильного приложения на Android эмуляторе не работает аутентификация или другие API запросы.

## Причина

На Android эмуляторе `localhost` или `127.0.0.1` указывают на сам эмулятор, а не на хост-машину (ваш компьютер). Поэтому запросы к `http://localhost:3000` не доходят до вашего API сервера.

## Решение

### Для Android эмулятора

В коде уже настроено использование `10.0.2.2` вместо `localhost` для Android. Это специальный адрес, который Android эмулятор использует для доступа к `localhost` хост-машины.

**Текущая конфигурация:**
- Android эмулятор: `http://10.0.2.2:3000/api/v1`
- iOS симулятор: `http://localhost:3000/api/v1` (работает нормально)

### Для физического Android устройства

Если вы тестируете на физическом устройстве, нужно использовать IP адрес вашего компьютера в локальной сети.

**Шаг 1: Узнайте IP адрес компьютера**

**Windows:**
```powershell
ipconfig
# Найдите IPv4 Address (например, 192.168.1.100)
```

**Linux/macOS:**
```bash
ifconfig
# или
ip addr show
# Найдите ваш IP адрес (например, 192.168.1.100)
```

**Шаг 2: Измените URL в коде**

Измените `ApiClient.ts` или `constants.ts`:

```typescript
const API_BASE_URL = __DEV__
  ? Platform.OS === 'android'
    ? 'http://192.168.1.100:3000/api/v1'  // Замените на ваш IP
    : 'http://localhost:3000/api/v1'
  : 'https://api.caremonitoring.com/api/v1';
```

**Шаг 3: Убедитесь, что устройство и компьютер в одной сети**

Оба устройства должны быть подключены к одной Wi-Fi сети.

**Шаг 4: Проверьте firewall**

Убедитесь, что firewall на компьютере разрешает входящие подключения на порт 3000.

**Windows:**
```powershell
# Разрешить порт в firewall
netsh advfirewall firewall add rule name="Node.js API" dir=in action=allow protocol=TCP localport=3000
```

**Linux:**
```bash
# UFW
sudo ufw allow 3000/tcp

# Firewalld (CentOS/RHEL)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

## Проверка подключения

### Проверка с эмулятора/устройства

1. Убедитесь, что API Gateway запущен на компьютере:
   ```bash
   curl http://localhost:3000/api/v1/health
   ```

2. Проверьте доступность API с эмулятора:
   - Откройте браузер в Android эмуляторе
   - Перейдите на `http://10.0.2.2:3000/api/v1/health`
   - Должен вернуться JSON ответ

3. Для физического устройства:
   - Откройте браузер на устройстве
   - Перейдите на `http://YOUR_IP:3000/api/v1/health`
   - Должен вернуться JSON ответ

## Учетные данные для тестирования

Используйте дефолтного пользователя-подопечного:

- **Email:** `ward@care-monitoring.ru`
- **Пароль:** `ward123`

**Важно:** Убедитесь, что seed-скрипт выполнен:
```bash
npm run db:seed
```

## Troubleshooting

### Ошибка: Network request failed

**Причины:**
1. API Gateway не запущен
2. Неправильный URL (проверьте, что используется `10.0.2.2` для эмулятора)
3. Firewall блокирует подключение

**Решение:**
1. Запустите API Gateway: `npm run dev:gateway` или `npm run dev:all`
2. Проверьте URL в коде
3. Проверьте firewall настройки

### Ошибка: Connection refused

**Причины:**
1. API Gateway не слушает на `0.0.0.0` (слушает только на `localhost`)
2. Неправильный порт

**Решение:**
1. Убедитесь, что API Gateway запущен и слушает на порту 3000
2. Проверьте порт в конфигурации

### Ошибка: CORS policy

**Примечание:** CORS не применяется к мобильным приложениям (React Native), только к веб-браузерам. Если вы видите ошибку CORS, значит запрос идет через браузер, а не через нативное приложение.

### Авторизация не проходит

**Проверьте:**
1. API Gateway запущен и доступен
2. Используете правильные учетные данные
3. Seed-скрипт выполнен (пользователи созданы)
4. URL правильный (`10.0.2.2:3000` для эмулятора)

**Проверка через curl:**
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"ward@care-monitoring.ru","password":"ward123"}'
```

Если curl работает, а приложение нет - проблема в URL или сети.

## Альтернативный способ: ADB port forwarding

Можно использовать port forwarding через ADB:

```bash
# Проброс порта 3000 с эмулятора на хост
adb reverse tcp:3000 tcp:3000
```

После этого можно использовать `localhost:3000` в коде, и он будет работать на эмуляторе.

**Недостаток:** Нужно выполнять команду после каждого перезапуска эмулятора или компьютера.

## Рекомендации

1. **Для разработки:** Используйте `10.0.2.2` для Android эмулятора (уже настроено)
2. **Для тестирования на устройстве:** Используйте IP адрес компьютера
3. **Для production:** Используйте домен с SSL (`https://api.caremonitoring.com`)

